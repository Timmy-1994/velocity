"use strict";var GradientCanvas=function(t){var n,i,e,a=t.minIntensity||0,o=t.maxIntensity||10,r=(t.opacity,t.reverseX||!1),s=t.reverseY||!1,h=t.dpx||2,l=["rgba(  0,  0,  0, 0.0)","rgba( 36,104,180, 0.8)","rgba( 60,157,194, 0.8)","rgba(128,205,193, 0.8)","rgba(151,218,168, 0.8)","rgba(198,231,181, 0.8)","rgba(238,247,217, 0.8)","rgba(255,238,159, 0.8)","rgba(252,217,125, 0.8)","rgba(255,182,100, 0.8)","rgba(252,150, 75, 0.8)","rgba(250,112, 52, 0.8)","rgba(245, 64, 32, 0.8)","rgba(237, 45, 28, 0.8)","rgba(220, 24, 32, 0.8)","rgba(180,  0, 35, 0.8)"],c=t.colorScale||l,d=M;"string"==typeof t.interpolateType&&(d="nearestneighbor"==t.interpolateType.toLowerCase()?function(t,n,i){if(!i)return null;var e=P(t-u,360)/y,a=(p-n)/_,o=Math.round(e),r=Math.round(a),s=i[r];if(s){var h=s[o];if(x(h))return h}return null}:M),"function"==typeof t.interpolateType&&(d=t.interpolateType);var u,p,y,_,m,f,v=t.data,g=function(t,n,i,e,a,o){var r=1-t,s=1-n;return i*(r*s)+e*(t*s)+a*(r*n)+o*(t*n)},w=function(t,n){var a=(i=function(t){t.dx||(t.dx=(t.lo2-t.lo1)/(t.nx-1)),t.dy||(t.dy=(t.la1-t.la2)/(t.ny-1));t.nx,t.ny;return{header:t,data:function(n){return t.d.v[n]}}}(t)).header;u=a.lo1,p=a.la1,y=a.dx,_=a.dy,m=a.nx,f=a.ny,e=[];for(var o=0,h=Math.floor(m*y)>=360,l=0;l<f;l++){for(var c=[],d=0;d<m;d++,o++)r?c.unshift(i.data(o)):c.push(i.data(o));h&&(r?c.unshift(c[c.length-1]):c.push(c[0])),s?e.unshift(c):e.push(c)}n(e)};function M(t,n,i){if(!i)return null;var e,a=P(t-u,360)/y,o=(p-n)/_,r=Math.floor(a),s=r+1,h=Math.floor(o),l=h+1;if(e=i[h]){var c=e[r],d=e[s];if(x(c)&&x(d)&&(e=i[l])){var m=e[r],f=e[s];if(x(m)&&x(f))return g(a-r,o-h,c,d,m,f)}}return null}var x=function(t){return null!=t&&"number"==typeof t},P=function(t,n){return t-n*Math.floor(t/n)},b=function(t){return t/180*Math.PI},C=function(n,i){var e=t.map.containerPointToLatLng(L.point(n,i));return[e.lng,e.lat]},D=function(t){var n=document.createElement("canvas"),i=n.getContext("2d"),e=i.createLinearGradient(0,0,0,256);n.width=1,n.height=256;var a=t.length;for(var o in t)e.addColorStop(o/a,t[o]);return i.fillStyle=e,i.fillRect(0,0,1,256),i.getImageData(0,0,1,256).data};n=D(c);var O=function(t,n,i){function e(n,i){var e=t[Math.round(n)];return e&&e[Math.round(i)]||null}e.release=function(){t=[]},i(n,e,t)},T=function(){S.field&&S.field.release()},S={params:t,start:function(i,r,s,l,c){b(l[0][1]),b(l[1][1]),b(l[1][0]),b(l[0][0]);T();var u=function(){console.time("[gradient]interpolateField"),function(t,n,i,a){var o=[],r=n.x;function s(i){n.width,n.height;for(var a=[],r=n.y;r<=n.yMax;r+=h){var s=C(i,r);if(s){var l=s[0],c=s[1];if(isFinite(l))for(var d=t(l,c,e),u=0;u<h;u++)a[r+u]=d}}for(u=0;u<h;u++)o[i+u]=a}!function t(){for(var i=Date.now();r<n.width;)if(s(r),r+=h,Date.now()-i>500)return void setTimeout(t,25);O(o,n,a)}()}(d,function(t,n,i){var e=t[0],a=t[1],o=Math.round(e[0]),r=Math.max(Math.floor(e[1],0),0);return Math.min(Math.ceil(a[0],n),n-1),{x:o,y:r,xMax:n,yMax:Math.min(Math.ceil(a[1],i),i-1),width:n,height:i}}(i,r,s),0,function(i,e,r){console.timeEnd("[gradient]interpolateField"),console.time("[gradient]draw"),S.field=e,function(i,e,r){for(var s,h,l,c=i.width,d=i.height,u=t.canvas.getContext("2d"),p=u.getImageData(0,0,c,d),y=p.data,_=[0,0,0,0],m=0;m<c;m++)for(var f=r[m],v=0;v<d;v++){var g=4*(v*c+m);s=f[v],h=_,l=void 0,l=Math.max(0,Math.min(1020,4*Math.round((s-a)/(o-a)*255))),h[0]=n[l+0],h[1]=n[l+1],h[2]=n[l+2],h[3]=n[l+3],y[g+0]=_[0],y[g+1]=_[1],y[g+2]=_[2],y[g+3]=_[3]}u.putImageData(p,0,0)}(i,0,r),console.timeEnd("[gradient]draw"),c&&"function"==typeof c&&c()})};e?u():(console.time("[gradient]buildGrid"),w(v,function(t){console.timeEnd("[gradient]buildGrid"),e=t,u()}))},stop:T,createField:O,interpolatePoint:d,setData:function(t){e=null,w(v=t,function(t){e=t})},setOptions:function(i){i.hasOwnProperty("minIntensity")&&(a=i.minIntensity),i.hasOwnProperty("maxIntensity")&&(o=i.maxIntensity),i.hasOwnProperty("opacity")&&+i.opacity,i.hasOwnProperty("dpx")&&(h=+i.dpx),i.hasOwnProperty("colorScale")&&(c=t.colorScale||l,n=D(c))}};return S};L.DomUtil.setTransform||(L.DomUtil.setTransform=function(t,n,i){var e=n||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+e.x+"px,"+e.y+"px)":"translate3d("+e.x+"px,"+e.y+"px,0)")+(i?" scale("+i+")":"")}),L.CanvasLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t){this._map=null,this._canvas=null,this._frame=null,this._delegate=null,L.setOptions(this,t)},delegate:function(t){return this._delegate=t,this},needRedraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this.drawLayer,this)),this},_onLayerDidResize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_setCanvasPos:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t)},_onLayerDidMove:function(t){var n=this;n.drawLayer(function(){n._setCanvasPos(),n._frame=null,L.Util.cancelAnimFrame(n._frame)})},getEvents:function(){var t={resize:this._onLayerDidResize,moveend:this._onLayerDidMove};return this._map.options.zoomAnimation&&L.Browser.any3d&&(t.zoomanim=this._animateZoom),t},onAdd:function(t){this._map=t,this._canvas=L.DomUtil.create("canvas","leaflet-layer"),this._canvas.style.pointerEvents="none",this.tiles={};var n=this._map.getSize();this._canvas.width=n.x,this._canvas.height=n.y;var i=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(i?"animated":"hide")),this.options.pane.appendChild(this._canvas),t.on(this.getEvents(),this),this._setCanvasPos();var e=this._delegate||this;e.onLayerDidMount&&e.onLayerDidMount(),this.needRedraw()},onRemove:function(t){var n=this._delegate||this;n.onLayerWillUnmount&&n.onLayerWillUnmount(),this.options.pane.removeChild(this._canvas),t.off(this.getEvents(),this),this._canvas=null},addTo:function(t){return t.addLayer(this),this},drawLayer:function(t){var n=this._map.getSize(),i=this._map.getBounds(),e=this._map.getZoom(),a=this._map.options.crs.project(this._map.getCenter()),o=this._map.options.crs.project(this._map.containerPointToLatLng(this._map.getSize())),r=this._delegate||this;r.onDrawLayer&&r.onDrawLayer({layer:this,canvas:this._canvas,bounds:i,size:n,zoom:e,center:a,corner:o},null,t),r.onDrawLayer},_setTransform:function(t,n,i){var e=n||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+e.x+"px,"+e.y+"px)":"translate3d("+e.x+"px,"+e.y+"px,0)")+(i?" scale("+i+")":"")},_animateZoom:function(t){var n=this._map.getZoomScale(t.zoom),i=L.Layer?this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),t.zoom,t.center):this._map._getCenterOffset(t.center)._multiplyBy(-n).subtract(this._map._getMapPanePos());L.DomUtil.setTransform(this._canvas,i,n)}}),L.canvasLayer=function(t){return new L.CanvasLayer(t)},L.Control.Velocity=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable",angleConvention:"bearingCCW",speedUnit:"m/s",onAdd:null,onRemove:null},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-velocity"),L.DomEvent.disableClickPropagation(this._container),t.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this.options.leafletVelocity.options.onAdd&&this.options.leafletVelocity.options.onAdd(),this._container},onRemove:function(t){t.off("mousemove",this._onMouseMove,this),this.options.leafletVelocity.options.onRemove&&this.options.leafletVelocity.options.onRemove()},vectorToSpeed:function(t,n,i){var e=Math.sqrt(Math.pow(t,2)+Math.pow(n,2));switch(i){case"k/h":case"km/h":return this.meterSec2kilometerHour(e);case"kt":case"kn":return this.meterSec2Knots(e);case"mph":return this.meterSec2milesPerHour(e)}return e},vectorToDegrees:function(t,n,i){i.endsWith("CCW")&&(n=n>0?n=-n:Math.abs(n));var e=Math.sqrt(Math.pow(t,2)+Math.pow(n,2)),a=180*Math.atan2(t/e,n/e)/Math.PI+180;return"bearingCW"!==i&&"meteoCCW"!==i||(a+=180)>=360&&(a-=360),a},meterSec2Knots:function(t){return t/.514},meterSec2kilometerHour:function(t){return 3.6*t},meterSec2milesPerHour:function(t){return 2.236936*t},_onMouseMove:function(t){var n=this.options.leafletVelocity._map.containerPointToLatLng(L.point(t.containerPoint.x,t.containerPoint.y)),i=this.options.leafletVelocity._windy.interpolatePoint(n.lng,n.lat),e="";e=i&&!isNaN(i[0])&&!isNaN(i[1])&&i[2]?"<strong>"+this.options.velocityType+" Direction: </strong>"+this.vectorToDegrees(i[0],i[1],this.options.angleConvention).toFixed(2)+"Â°, <strong>"+this.options.velocityType+" Speed: </strong>"+this.vectorToSpeed(i[0],i[1],this.options.speedUnit).toFixed(2)+this.options.speedUnit:this.options.emptyString,this._container.innerHTML=e}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.velocity=function(t){return new L.Control.Velocity(t)},L.GradientLayer=(L.Layer?L.Layer:L.Class).extend({options:{colorScale:null,data:null,reverseX:!1,reverseY:!1,dpx:2,getValue:null},_map:null,_canvasLayer:null,_context:null,_mouseControl:null,_init:null,_timer:0,_width:0,_height:0,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this._paneName=this.options.paneName||"overlayPane";let n=t._panes.overlayPane;t.getPane&&((n=t.getPane(this._paneName))||(n=t.createPane(this._paneName))),this._canvasLayer=L.canvasLayer({pane:n}).delegate(this),this._canvasLayer.addTo(t),this._map=t},onRemove:function(t){this._destroy()},setData:function(t){this.options.data=t,this._init&&(this._init.setData(t),this._clearAndRestart()),this.fire("load")},setOpacity:function(t){console.log("this._canvasLayer",this._canvasLayer),this._canvasLayer.setOpacity(t)},setOptions:function(t){this.options=Object.assign(this.options,t),t.hasOwnProperty("data")&&(this.options.data=t.data),this._init&&(this._init.setOptions(t),t.hasOwnProperty("data")&&this._init.setData(t.data),this._clearAndRestart()),this.fire("load")},onDrawLayer:function(t,n,i){var e=this;this._init?this.options.data&&(this._timer&&clearTimeout(e._timer),this._timer=setTimeout(function(){e._draw(i)},250)):this._initLayer(this)},_initLayer:function(t){t._resize();const n=Object.assign({canvas:t._canvasLayer._canvas,map:this._map},t.options);this._init=new GradientCanvas(n),this._context=this._canvasLayer._canvas.getContext("2d"),this._canvasLayer._canvas.classList.add("gradient-overlay"),this.onDrawLayer(),this._map.on("dragstart",t._init.stop),this._map.on("dragend",t._clearAndRestart),this._map.on("zoomstart",t._init.stop),this._map.on("zoomend",t._clearAndRestart),this._map.on("resize",t._resize)},_initMouseHandler:function(t){if(t&&(this._map.removeControl(this._mouseControl),this._mouseControl=!1),!this._mouseControl&&this.options.displayValues){var n=this.options.displayOptions||{};n.leafletGradient=this,this._mouseControl=L.control.velocity(n).addTo(this._map)}},_clearAndRestart:function(){this._context&&this._context.clearRect(0,0,this._width,this._height),this._init&&this._draw()},_draw:function(t){var n=this._map.getBounds(),i=this._map.getSize();this._init.start([[0,0],[i.x,i.y]],i.x,i.y,[[n._southWest.lng,n._southWest.lat],[n._northEast.lng,n._northEast.lat]],t)},_resize:function(t){var n=t?t.newSize:this._map.getSize();this._width=n.x,this._height=n.y,this._init&&this._init.stop(),this._context&&this._context.clearRect(0,0,this._width,this._height)},_destroy:function(){this._timer&&clearTimeout(this._timer),this._init&&this._init.stop(),this._context&&this._context.clearRect(0,0,this._width,this._height),this._mouseControl&&this._map.removeControl(this._mouseControl),this._mouseControl=null,this._init=null,this._map.removeLayer(this._canvasLayer)}}),L.gradientLayer=function(t){return new L.GradientLayer(t)},L.VelocityLayer=(L.Layer?L.Layer:L.Class).extend({options:{displayValues:!0,displayOptions:{velocityType:"Velocity",position:"bottomleft",emptyString:"No velocity data"},maxVelocity:10,colorScale:null,data:null,reverseX:!1,reverseY:!1,waveStyle:!1},_map:null,_canvasLayer:null,_windy:null,_context:null,_timer:0,_mouseControl:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this._paneName=this.options.paneName||"overlayPane";let n=t._panes.overlayPane;t.getPane&&((n=t.getPane(this._paneName))||(n=t.createPane(this._paneName))),this._canvasLayer=L.canvasLayer({pane:n}).delegate(this),this._canvasLayer.addTo(t),this._map=t},onRemove:function(t){this._destroyWind()},setData:function(t){this.options.data=t,this._windy&&(this._windy.setData(t),this._clearAndRestart()),this.fire("load")},setOpacity:function(t){console.log("this._canvasLayer",this._canvasLayer),this._canvasLayer.setOpacity(t)},setOptions:function(t){this.options=Object.assign(this.options,t),t.hasOwnProperty("displayOptions")&&(this.options.displayOptions=Object.assign(this.options.displayOptions,t.displayOptions),this._initMouseHandler(!0)),t.hasOwnProperty("data")&&(this.options.data=t.data),this._windy&&(this._windy.setOptions(t),t.hasOwnProperty("data")&&this._windy.setData(t.data),this._clearAndRestart()),this.fire("load")},onDrawLayer:function(t,n,i){this._windy?this.options.data&&(this._timer&&L.Util.cancelAnimFrame(this._timer),this._timer=L.Util.requestAnimFrame(this._clearAndRestart,this),i&&"function"==typeof i&&i()):this._initWindy(this)},_startWindy:function(){var t=this._map.getBounds(),n=this._map.getSize();this._windy.start([[0,0],[n.x,n.y]],n.x,n.y,[[t._southWest.lng,t._southWest.lat],[t._northEast.lng,t._northEast.lat]])},getEvents:function(){return{movestart:this._startDrag,moveend:this._stopDrag,zoomstart:this._clearWind,resize:this._clearAndRestart}},_initWindy:function(t){const n=Object.assign({canvas:t._canvasLayer._canvas,map:this._map},t.options);this._windy=new Windy(n),this._context=this._canvasLayer._canvas.getContext("2d"),this._canvasLayer._canvas.classList.add("velocity-overlay"),this.onDrawLayer(),this._map.on(this.getEvents(),this),this._initMouseHandler(!1)},_initMouseHandler:function(t){if(t&&(this._map.removeControl(this._mouseControl),this._mouseControl=!1),!this._mouseControl&&this.options.displayValues){var n=this.options.displayOptions||{};n.leafletVelocity=this,this._mouseControl=L.control.velocity(n).addTo(this._map)}},_startDrag:function(t){this._windy&&this._windy.startDrag()},_stopDrag:function(t){this._windy&&(this._windy.stopDrag(),this._clearWind())},_clearAndRestart:function(t){this._context&&this._context.clearRect(0,0,3e3,3e3),this._windy&&this._startWindy()},_clearWind:function(t){this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3)},_destroyWind:function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._mouseControl&&this._map.removeControl(this._mouseControl),this._mouseControl=null,this._windy=null,this._map.removeLayer(this._canvasLayer)}}),L.velocityLayer=function(t){return new L.VelocityLayer(t)};var Windy=function(t){var n=this,i=t.minVelocity||0,e=t.maxVelocity||10,a=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),o=t.particleAge||90,r=t.particleMinAge||10,s=t.lineWidth||1,h=t.particleMultiplier||1/300,l=Math.pow(window.devicePixelRatio,1/3)||1.6,c=t.frameRate||15,d=1e3/c,u=t.opacity||.97,p=t.reverseX||!1,y=t.reverseY||!1,_=t.waveStyle||!1,m=t.dataFn||null;const f=t.colorScale||["rgb( 36,104,180)","rgb( 60,157,194)","rgb(128,205,193)","rgb(151,218,168)","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150, 75)","rgb(250,112, 52)","rgb(245, 64, 32)","rgb(237, 45, 28)","rgb(220, 24, 32)","rgb(180,  0, 35)"];var v=[NaN,NaN,null];n.grid=null;var g=t.data,w=function(t){return null!=t},M=function(t,n,i,e,a,o,r){var s=r[0]*o,h=r[1]*o,l=x(t,n,i,e,a);return r[0]=l[0]*s+l[2]*h,r[1]=l[1]*s+l[3]*h,r},x=function(t,n,i,e,a){var o=2*Math.PI,r=Math.pow(10,-5.2),s=n<0?r:-r,h=i<0?r:-r;const l=P(n+s,i),c=P(n,i+h);var d=Math.cos(i/360*o);return[(l[0]-e)/s/d,(l[1]-a)/s/d,(c[0]-e)/h,(c[1]-a)/h]},P=function(t,n){const i=b(S.south),e=b(S.north),a=R.width/(S.east-S.west),o=R.height/(e-i);let r=b(V(n));return[(V(t)-S.west)*a,r=(e-r)*o]},b=function(t){return Math.log(Math.tan(t/2+Math.PI/4))};function C(t){var n,i=this;i.uData,i.vData,i.scalar,t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":n=t,i.uData=t.data;break;case"1,3":case"2,3":i.vData=t.data;break;default:i.scalar=t.data}});var e=!0;t.length<2&&(e=!1),e||console.log("Windy Error: data must have at least two components (u,v)");var a=n.header;if(a.hasOwnProperty("gridDefinitionTemplate")&&0!=a.gridDefinitionTemplate&&(e=!1),e||console.log("Windy Error: Only data with Latitude_Longitude coordinates is supported"),e=!0,this.Î»0=a.lo1,this.Ï0=a.la1,this.ÎÎ»=a.dx,this.ÎÏ=a.dy,this.ni=a.nx,this.nj=a.ny,a.hasOwnProperty("scanMode")){var o=a.scanMode.toString(2),r=(o=("0"+o).slice(-8)).split("").map(Number).map(Boolean);r[0]&&(this.ÎÎ»=-this.ÎÎ»),r[1]&&(this.ÎÏ=-this.ÎÏ),r[2]&&(e=!1),r[3]&&(e=!1),r[4]&&(e=!1),r[5]&&(e=!1),r[6]&&(e=!1),r[7]&&(e=!1),e||console.log("Windy Error: Data with scanMode: "+a.scanMode+" is not supported.")}this.date=new Date(a.refTime),this.date.setHours(this.date.getHours()+a.forecastTime)}function D(t,n,i,e){this.header=t,this.bounds=n,this.grid=null,this.Î»0=t.Î»0,this.Ï0=t.Ï0,this.ÎÎ»=t.ÎÎ»,this.ÎÏ=t.ÎÏ,this.ni=t.ni,this.nj=t.nj,this.buildGrid(t),e(this)}function O(t){this.x,this.y,this.age=t,this.xt,this.yt,this.intensity}C.prototype.data=function(t,n,i){return[this.uData[t],this.vData[t]]},D.prototype.buildGrid=function(t){var n=t.ni,i=t.nj;this.grid=[];var e=this.grid,a=0,o=Math.floor(n*this.ÎÎ»)>=360;const r=t.uData,s=t.vData;for(var h=0;h<i;h++){for(var l=[],c=0;c<n;c++,a++)p?l.unshift(t.data(a,r,s)):l.push(t.data(a,r,s));o&&(p?l.unshift(l[l.length-1]):l.push(l[0])),y?e.unshift(l):e.push(l)}},D.prototype.release=function(){this.grid=null,this.header=null},D.prototype.get=function(t,n){var i=this.grid[Math.round(t)];return i&&i[Math.round(n)]||v},D.prototype.interpolate=function(t,n){if(!this.grid)return null;var i,e=this.floorMod(t-this.Î»0,360)/this.ÎÎ»,a=(this.Ï0-n)/this.ÎÏ,o=Math.floor(e),r=o+1,s=Math.floor(a),h=s+1,l=this.grid;if(i=l[s]){var c=i[o],d=i[r];if(w(c)&&w(d)&&(i=l[h])){var u=i[o],p=i[r];if(w(u)&&w(p))return this.bilinearInterpolateVector(e-o,a-s,c,d,u,p)}}return null},D.prototype.bilinearInterpolateVector=function(t,n,i,e,a,o){var r=1-t,s=1-n,h=r*s,l=t*s,c=r*n,d=t*n,u=i[0]*h+e[0]*l+a[0]*c+o[0]*d,p=i[1]*h+e[1]*l+a[1]*c+o[1]*d;return[u,p,Math.sqrt(u*u+p*p)]},D.prototype.floorMod=function(t,n){return t-n*Math.floor(t/n)},D.prototype.randomize=function(t){var n,i,e,a=this.bounds,o=2;do{n=Math.round(Math.floor(Math.random()*a.width)+a.x),i=Math.round(Math.floor(Math.random()*a.height)+a.y),e=this.interpolate(n,i)}while((null===e||null===e[2])&&o-- >0);return t.x=n,t.y=i,t},O.prototype.maxAge=o,O.prototype.add=function(t){var n=this;return n.xt=n.x+t[0],n.yt=n.y+t[1],n};var T,S,R,A,z,W,V=function(t){return t/180*Math.PI},E=function(n,i,e){var a=t.map.containerPointToLatLng(L.point(n,i));return[a.lng,a.lat]},N=function(n,i,e){var a=t.map.latLngToContainerPoint(L.latLng(n,i));return[a.x,a.y]},U=E,F=N,I=L.DomUtil.getPosition(t.map._mapPane),k=function(n,i,e){var a=L.point(n,i),o=t.map.layerPointToLatLng(a.subtract(I));return[o.lng,o.lat]},H=function(n,i,e){var a=t.map.latLngToLayerPoint(L.latLng(n,i)).add(I);return[a.x,a.y]},j=function(){var t=Math.round(R.width*R.height*h);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(t*=l);var i=n.grid;W=[];for(var e=0;e<t;e++)W.push(i.randomize(new O(Math.floor(Math.random()*(o-r)+r)+0)));X()};var B,G=function(t){t.globalCompositeOperation="destination-in",t.fillRect(R.x,R.y,R.width,R.height),t.globalCompositeOperation="lighter",t.globalAlpha=0===u?0:.9*u,z.forEach(function(n,i){n.length>0&&(t.beginPath(),t.strokeStyle=A[i],n.forEach(function(n){t.moveTo(n.x,n.y),t.lineTo(n.xt,n.yt),n.x=n.xt,n.y=n.yt}),t.stroke())})},q=Date.now(),X=function(){B=requestAnimationFrame(X);var t,i,e,r=Date.now(),s=r-q;s>d&&(q=r-s%d,t={},i=(S.south-S.north)*(S.west-S.east),e=a*Math.pow(i,.4),z.forEach(function(t){t.length=0}),W.forEach(function(i){i.age>o&&(n.grid.randomize(i).age=0);var a=i.x,r=i.y,s=E(a,r),h=s[0],l=s[1],c=n.grid.interpolate(h,l);if(c){var d=(c=M(t,h,l,a,r,e,c))[2];null===d||0==d?i.age=o:(i.add(c),_&&(d=i.age),z[A.indexFor(d)].push(i))}i.age+=1}),G(T))},Y=function(){n.grid&&n.grid.release(),B&&L.Util.cancelAnimFrame(B)};return n.params=t,n.start=function(a,h,l,c){function d(t,n){return f.indexFor=function(i){return Math.max(0,Math.min(f.length-1,Math.round((i-t)/(n-t)*(f.length-1))))},f}S={south:V(c[0][1]),north:V(c[1][1]),east:V(c[1][0]),west:V(c[0][0]),width:h,height:l},Y(),A=d(i,e),_&&(A=d(r,o)),z=A.map(function(){return[]});var p=`rgba(0, 0, 0, ${u})`;(T=t.canvas.getContext("2d")).lineWidth=s,T.fillStyle=p,T.globalAlpha=.6,R=function(t,n,i){var e=t[0],a=t[1],o=Math.round(e[0]),r=Math.max(Math.floor(e[1],0),0);return Math.min(Math.ceil(a[0],n),n-1),{x:o,y:r,xMax:n,yMax:Math.min(Math.ceil(a[1],i),i-1),width:n,height:i}}(a,h,l);var y=new C(g);m&&"function"==typeof m&&(y.data=m),new D(y,R,S,function(t){n.grid=t,j()})},n.stop=Y,n.draw=G,n.setData=function(t){g=t},n.setOptions=function(t){t.hasOwnProperty("minVelocity")&&(i=t.minVelocity),t.hasOwnProperty("maxVelocity")&&(e=t.maxVelocity),t.hasOwnProperty("velocityScale")&&(a=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1)),t.hasOwnProperty("particleAge")&&(o=t.particleAge),t.hasOwnProperty("particleMinAge")&&(r=t.particleMinAge),t.hasOwnProperty("lineWidth")&&(s=t.lineWidth),t.hasOwnProperty("particleMultiplier")&&(h=t.particleMultiplier),t.hasOwnProperty("opacity")&&(u=+t.opacity),t.hasOwnProperty("frameRate")&&(c=t.frameRate),d=1e3/c,t.hasOwnProperty("waveStyle")&&(_=t.waveStyle),t.hasOwnProperty("dataFn")&&(m=t.dataFn)},n.startDrag=function(){I=L.DomUtil.getPosition(t.map._mapPane),E=k,N=H},n.stopDrag=function(){E=U,N=F},n.interpolatePoint=function(t,i){return n.grid?n.grid.interpolate(t,i):null},n};